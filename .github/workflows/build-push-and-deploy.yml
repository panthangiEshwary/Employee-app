name: Build & Deploy App via GHCR

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      # ------------------------------
      # Backend Build
      # ------------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Build Backend
        run: mvn -B -DskipTests=true clean package
        working-directory: backend

      # ------------------------------
      # Frontend Build
      # ------------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install
        working-directory: frontend

      - name: Fix Angular CLI permissions
        run: chmod +x ./node_modules/.bin/ng
        working-directory: frontend

      - name: Build frontend (Production)
        run: npm run build -- --configuration production
        working-directory: frontend

      # ------------------------------
      # Login to GHCR
      # ------------------------------
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_PAT }}

      # ------------------------------
      # Lowercase Repo Owner for GHCR
      # ------------------------------
      - name: Set lowercase repo owner
        run: echo "REPO_OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      # ------------------------------
      # Docker Builds
      # ------------------------------
      - name: Build Backend Image
        run: docker build -t ghcr.io/${REPO_OWNER_LC}/employee-backend:${{ github.run_number }} backend

      - name: Build Frontend Image
        run: docker build -t ghcr.io/${REPO_OWNER_LC}/employee-frontend:${{ github.run_number }} frontend

      # ------------------------------
      # Push to GHCR
      # ------------------------------
      - name: Push Images to GHCR
        run: |
          docker push ghcr.io/${REPO_OWNER_LC}/employee-backend:${{ github.run_number }}
          docker push ghcr.io/${REPO_OWNER_LC}/employee-frontend:${{ github.run_number }}

      # ======================================================
      # CD PART (SSM)
      # ======================================================

      # ------------------------------
      # AWS Credentials (OIDC)
      # ------------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ------------------------------
      # Get EC2 Instance ID
      # ------------------------------
      - name: Get App EC2 instance id
        id: get_instance
        run: |
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=Employee-App-Server" \
                      "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].InstanceId" \
            --output text)

          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "Found instance: $INSTANCE_ID"

      # ------------------------------
      # Get RDS Endpoint
      # ------------------------------
      - name: Get RDS Endpoint
        id: get_rds
        run: |
          DB_HOST=$(aws rds describe-db-instances \
            --db-instance-identifier employee-db \
            --query "DBInstances[0].Endpoint.Address" \
            --output text)

          echo "db_host=$DB_HOST" >> $GITHUB_OUTPUT
          echo "Resolved DB endpoint: $DB_HOST"

      # ------------------------------
      # Trigger SSM Deploy
      # ------------------------------
      - name: Trigger SSM Deploy Script
        if: ${{ steps.get_instance.outputs.instance_id != '' }}
        run: |
          aws ssm send-command \
            --instance-ids "${{ steps.get_instance.outputs.instance_id }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy CI build" \
            --parameters "commands=[
              \"GHCR_USER=${{ github.repository_owner }} \
              GHCR_TOKEN=${{ secrets.GHCR_PAT }} \
              DB_HOST=${{ steps.get_rds.outputs.db_host }} \
              DB_USER=admin \
              DB_PASS=${{ secrets.DB_MASTER_PASSWORD }} \
              BACKEND_IMAGE=ghcr.io/${REPO_OWNER_LC}/employee-backend:${{ github.run_number }} \
              FRONTEND_IMAGE=ghcr.io/${REPO_OWNER_LC}/employee-frontend:${{ github.run_number }} \
              /opt/app/deploy.sh\"
            ]"
